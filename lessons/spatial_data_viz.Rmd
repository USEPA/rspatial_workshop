---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, echo=FALSE, warning=FALSE, purl=FALSE, message=FALSE}
options(repos="http://cran.rstudio.com/")
pkgs <- c("sp","rgdal","rgeos","raster","knitr","quickmapr","leaflet","mapview", "dplyr","sf","here")
x<-lapply(pkgs, library, character.only = TRUE)
opts_chunk$set(tidy=T)
```

```{r data_setup, echo=FALSE,cache=TRUE,message=FALSE}
dc_metro <- st_read(here("data/Metro_Lines.shp"), stringsAsFactors = FALSE)
dc_metro_sttn <- st_read(here("data/metrostations.geojson"), stringsAsFactors = FALSE)
dc_elev <- raster(here("data/dc_ned.tif"))
dc_nlcd <- raster(here("data/dc_nlcd.tif"))
esri_alb_p4 <- proj4string(dc_nlcd)
dc_metro_alb <- st_transform(dc_metro,esri_alb_p4)
dc_metro_sttn_alb <- st_transform(dc_metro_sttn,
                                  st_crs(dc_metro_alb)$proj4string)
dc_elev_alb <- projectRaster(dc_elev,crs=st_crs(dc_metro_alb)$proj4string) 
sttn_buff_500 <- st_buffer(dc_metro_sttn_alb, dist = 500) %>%
  st_union()
```

# Visualizing Spatial Data in R
Visualizing spatial data in interactive and static forms is one of the defining characteristics of GIS.  With interactive visualization and analysis, R, has not been quite up to the standards of a stand-alone GIS like QGIS or ArcGIS. Static visualization (e.g. maps) in R are, in my opinion, on par with anything you can create with a dedicated GIS.  A few (now somewhat dated) examples of maps built with R show this:

- [London Bike Hires](http://spatialanalysis.co.uk/wp-content/uploads/2012/02/bike_ggplot.png)
- [Facebook Users](http://paulbutler.org/archives/visualizing-facebook-friends/facebook_map.png)

For quick simple static visualization we can use the base plotting functions that `sf` and `raster` provide.  For maps with a bit more cartographic flair we can use `ggplot2`.  We will show examples of both of these.  

For interactive visualization of spatial data, the bread and butter of GIS, we will use the `mapview` package which provides an easy way to visualize `sf` (and `sp`) objects using Leaflet javascript libraries.

## Lesson Outline
- [Visualizing spatial data with `sf` and `raster`](#visualizing-spatial-data-with-sf-and-raster)
- [Visualizing spatial data with `ggplot2`](#visualizing-spatial-data-with-ggplot2)
- [Mapping with javascript: `mapview`](#mapping-with-javascript-mapview)

## Lesson Exercises
- [Exercise 4.1](#exercise-41)
- [Exercise 4.2](#exercise-42)

## Visualizing spatial data with `sf` and `raster`

The default plotting tools from `sf` and `raster` are good enough for most of your needs and we have already seen these functions in action.  We will show these again.

To create a plot of a single layer

```{r}
plot(st_geometry(dc_metro))
#Play with symbology
plot(st_geometry(dc_metro), col="red", lwd = 3)
#Use data to color
plot(st_geometry(dc_metro), col=dc_metro$NAME, lwd=dc_metro$GIS_ID)
```

To create a plot of a multiple layers, we can use the "add" argument.

```{r}
plot(dc_metro)
#Add stations, change color,size, and symbol
plot(dc_metro_sttn, add=T, col="red", pch=15, cex=1.2)
```

Add some raster data in.

```{r}
plot(dc_elev)
plot(dc_metro, add=T)
plot(dc_metro_sttn, add=T, col="red", pch=15,cex=1.2)
```

We can certainly get fancier with the final plot, but that means digging into the details of plotting with base R.  That'd be a workshop in and of itself!

## Visualizing spatial data with `ggplot2`

## Mapping with javascript: `mavpiew`

Many of the visualization tasks (e.g. zoom, pan, identify) are implemented (and implemented well) in various javascript libraries.  As such, much of the development in R has been towards packages to access javascript libraries and allow the display of R objects. Our efforts are going to focus on the `leaflet` package which, unsurprisingly, allows us to access the leaflet javascript library.  The `leaflet` package is written and maintained through RStudio.  For more on how to use `leaflet`, check out [RStudio's tutorial](https://rstudio.github.io/leaflet/).

Before we build some maps, let's get everything we need installed and loaded.

```{r eval=FALSE}
install.packages("leaflet")
library(leaflet)
```

Although the maps we can create with `leaflet` are really nice, there is one downside.  It is expected that the data are all in unprojected latitude and longitude, so if you have projected data, that will need to be converted back in to geographic coordinates.  For us, we have examples of data that are already in the correct projection.

One of the nice things about the `leaflet` interface is that it is really easy to work iteratively and build your maps by adding data and options to an existing leaflet map. So lets start with the bare minimum.

```{r, eval=FALSE}
map <- leaflet()
map <- addTiles(map)
map <- addPolylines(map,data=dc_metro)
map
```

There are lots of tiles available to us.  The default is Open Street Map. We can try out some of the other available tiles. Full list of options available from <http://leaflet-extras.github.io/leaflet-providers/preview/>.

```{r, eval=FALSE}
map <- leaflet()
map <- addPolylines(map,data=dc_metro)
map <- addProviderTiles(map,"Esri.NatGeoWorldMap")
map
#or
map <- leaflet()
map <- addPolylines(map,data=dc_metro)
map <- addProviderTiles(map,"MapQuestOpen.Aerial")
map
```

And we can add other layers in and also change their styling.

```{r, eval=FALSE}
map <- leaflet()
map <- addTiles(map)
map <- addPolylines(map,data=dc_metro)
map <- addCircles(map, data=dc_metro_sttn,
                  color="red", weight = 7,
                  popup = dc_metro_sttn$NAME)

map
```

Lastly, we can add in rasters.

```{r, eval=FALSE}
map <- leaflet()
map <- addTiles(map)
map <- addPolylines(map,data=dc_metro)
#Note: Takes a while.  Does projection behind the scenes.
map <- addRasterImage(map, dc_elev)
map
```

## Exercise 4.2
For this exercise, we will create a `mapview` map

1. Create a leaflet map and add in the DC boundary.  Look at the `addPolygons` help to get you started.
2. Add in the NLCD you clipped out as part of lesson 3.

## Static maps with `ggplot2`

- [ggplot2](https://cran.r-project.org/web/packages/ggplot2/index.html): THE data viz package for R.  Also can be used to make maps (it is what I use for my static maps). Requires additional processing of the spatial data to create plots, but has almost unlimited possibilities for creating maps.
